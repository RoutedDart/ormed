---
sidebar_position: 2
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Repository

Repositories give you model-oriented CRUD with predictable defaults. They accept tracked models, DTOs, and raw maps, so you can start simple and add type safety as your app grows.

## Prerequisites

- [Query Builder](./query-builder)
- [Defining Models](../models/defining-models)

## What Youâ€™ll Learn

- How to perform insert/read/update/delete flows with repository APIs
- Which input shapes each operation accepts
- When repository APIs are a better fit than lower-level query composition

## Step Outcome

By the end of this page, you should be able to implement common write workflows with `repo<T>()` and know when to switch to query builder methods.

:::note Snippet context
- Snippets focus on repository calls and omit full setup.
- You can obtain a repository from either:
  - a `DataSource`/`QueryContext` (explicit, recommended for multi-database apps), or
  - generated model helpers (uses the default connection).
  
The default connection is managed by `ConnectionManager` and is usually set when you call `await dataSource.init()`.
:::

## 1. Get a Repository

<Tabs groupId="repo-get" defaultValue="default">
  <TabItem value="default" label="Default connection">

```dart file=../../examples/lib/repository.dart#repo-get-static
```

  </TabItem>
  <TabItem value="datasource" label="From DataSource">

```dart file=../../examples/lib/repository.dart#repo-get
```

  </TabItem>
</Tabs>

Use default helpers for single-connection apps. Use `dataSource.repo<T>()` when routing queries by connection name/tenant.

## 2. Insert Records

### Insert one row

```dart file=../../examples/lib/repository.dart#repo-insert

```

### Insert many rows

```dart file=../../examples/lib/repository.dart#repo-insert-many

```

### Upsert (insert-or-update)

```dart file=../../examples/lib/repository.dart#repo-upsert

```

## 3. Read Records

### Find by Primary Key

```dart file=../../examples/lib/repository.dart#repo-find
```

### First, count, and exists

```dart file=../../examples/lib/repository.dart#repo-first-count
```

## 4. Update Records

### Update one model or one matched row

```dart file=../../examples/lib/repository.dart#repo-update

```

### Update many rows/models

```dart file=../../examples/lib/repository.dart#repo-update-many

```

### `where` accepts multiple input types

The `where` parameter accepts various input types:

```dart file=../../examples/lib/repository.dart#repo-where-types

```

### Typed callback predicates

```dart file=../../examples/lib/repository.dart#repo-where-typed
```

:::caution Important
When using a callback for `where`, the parameter is `dynamic` unless you explicitly type it.
Untyped callbacks still run, but you lose static checking.
```dart file=../../examples/lib/repository.dart#repo-where-typing-caution
```
:::

## 5. Delete and Restore

### Delete one record

```dart file=../../examples/lib/repository.dart#repo-delete

```

### Delete many records

```dart file=../../examples/lib/repository.dart#repo-delete-many

```

### Soft delete helpers

For models that include `SoftDeletes`:

```dart file=../../examples/lib/repository.dart#repo-soft-delete
```

## 6. Relation and Error Workflows

### Relation loading from repository-fetched models

```dart file=../../examples/lib/repository.dart#repo-relations
```

### Error handling patterns

```dart file=../../examples/lib/repository.dart#repo-errors

```

## 7. When to Use Repository vs Query Builder

- Prefer `Repository` for CRUD operations tied to one model type.
- Prefer `Query Builder` for complex filtering, joins, projections, aggregates, and SQL-shape control.
- Combine them freely: read with query builder, mutate with repository.

## Verify Your Setup

- You can fetch a repository from both default helpers and `DataSource`.
- You can insert/update/delete without dropping to raw SQL.
- Your `where` callbacks are typed where predicate fields are used.

## Read This Next

- [Query Builder](./query-builder)
- [Loading Relations](./relations)
- [DataSource](./data-source)
